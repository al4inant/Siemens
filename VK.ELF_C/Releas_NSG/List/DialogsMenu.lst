##############################################################################
#                                                                            #
# IAR ARM ANSI C/C++ Compiler V4.42A/W32 EVALUATION    14/Dec/2018  23:20:52 #
# Copyright 1999-2005 IAR Systems. All rights reserved.                      #
#                                                                            #
#    Cpu mode        =  interwork                                            #
#    Endian          =  little                                               #
#    Stack alignment =  4                                                    #
#    Source file     =  E:\Users\alfinant\Documents\Siemens\alfinant\src_iar #
#                       \VK.ELF_C\DialogsMenu.c                              #
#    Command line    =  E:\Users\alfinant\Documents\Siemens\alfinant\src_iar #
#                       \VK.ELF_C\DialogsMenu.c -D NEWSGOLD -D DEVELOP -lCN  #
#                       E:\Users\alfinant\Documents\Siemens\alfinant\src_iar #
#                       \VK.ELF_C\Releas_NSG\List\ -la                       #
#                       E:\Users\alfinant\Documents\Siemens\alfinant\src_iar #
#                       \VK.ELF_C\Releas_NSG\List\ -o                        #
#                       E:\Users\alfinant\Documents\Siemens\alfinant\src_iar #
#                       \VK.ELF_C\Releas_NSG\Obj\ -z9 --cpu_mode arm         #
#                       --endian little --cpu ARM926EJ-S --stack_align 4     #
#                       --interwork --diag_suppress Pe301 -e --fpu None      #
#                       --dlib_config E:\Users\alfinant\Documents\Siemens\IA #
#                       R\ARM\LIB\dl5tpainl8n.h -I                           #
#                       E:\Users\alfinant\Documents\Siemens\IAR\ARM\INC\     #
#                       --inline_threshold=2                                 #
#    List file       =  E:\Users\alfinant\Documents\Siemens\alfinant\src_iar #
#                       \VK.ELF_C\Releas_NSG\List\DialogsMenu.lst            #
#    Object file     =  E:\Users\alfinant\Documents\Siemens\alfinant\src_iar #
#                       \VK.ELF_C\Releas_NSG\Obj\DialogsMenu.r79             #
#                                                                            #
#                                                                            #
##############################################################################

E:\Users\alfinant\Documents\Siemens\alfinant\src_iar\VK.ELF_C\DialogsMenu.c
      1          #include <siemens\swilib.h>
      2          #include "rect_patcher.h"

   \                                 In segment CODE, align 4, keep-with-next
   \   __??Code32?? __code __interwork __atpcs void patch_header(HEADER_DESC const *)
   \                     patch_header:
   \   00000000   10402DE9           PUSH     {R4,LR}
   \   00000004   0040A0E1           MOV      R4,R0
   \   00000008   0000A0E3           MOV      R0,#+0
   \   0000000C   B000C4E1           STRH     R0,[R4, #+0]
   \   00000010   B200C4E1           STRH     R0,[R4, #+2]
   \   00000014   888100EF           SWI      +33160
   \   00000018   010040E2           SUB      R0,R0,#+1
   \   0000001C   B400C4E1           STRH     R0,[R4, #+4]
   \   00000020   8A8100EF           SWI      +33162
   \   00000024   010040E2           SUB      R0,R0,#+1
   \   00000028   B600C4E1           STRH     R0,[R4, #+6]
   \   0000002C   1080BDE8           POP      {R4,PC}          ;; return
      3          #include <siemens\pnglist.h>
      4          #include "dyn_images.h"
      5          #include "dyn_theme.h"
      6          #include "process.h"
      7          #include "socket_work.h"
      8          #include "http.h"
      9          #include "vk_api.h"
     10          #include "main.h"
     11          #include "chat.h"
     12          #include "anim_widget.h"
     13          #include "string_util.h"
     14          #include "vk_work.h"
     15          

   \                                 In segment DATA_C, align 4, align-sorted
     16          static const char percent_t[]="%t";
   \                     percent_t:
   \   00000000   257400             DC8 "%t"
   \   00000003   256400             DC8 "%d"
   \   00000006   0000               DC8 0, 0
   \   00000008   D1EEEEE1F9E5       DC8 "\321\356\356\341\371\345\355\350\377"
   \              EDE8FF00    
   \   00000012   0000               DC8 0, 0
   \   00000014   25642F256400       DC8 "%d/%d"
   \   0000001A   0000               DC8 0, 0
   \   0000001C   E2EBEEE6E5ED       DC8 "\342\353\356\346\345\355\350\345"
   \              E8E500      
   \   00000025   000000             DC8 0, 0, 0
     17          static const char percent_d[]="%d";
     18          
     19          extern const char DIR[];
     20          extern int CreateDebugGUI();
     21          

   \                                 In segment DATA_I, align 4, align-sorted
     22          static HEADER_DESC hdr={0,0,0,0,NULL,NULL,LGP_NULL};
   \                     hdr:
   \   00000000                      DS8 20
   \   00000014                      REQUIRE `?<Initializer for hdr>`
   \   00000014                      DS8 4
   \   00000018                      REQUIRE `?<Initializer for ws_hdr>`
   \   00000018                      DS8 4
   \   0000001C                      REQUIRE `?<Initializer for item_count>`
   \   0000001C                      DS8 4
   \   00000020                      REQUIRE `?<Initializer for item_cursor>`
   \   00000020                      DS8 4
   \   00000024                      REQUIRE `?<Initializer for hdr_icon>`
     23          static WSHDR  *ws_hdr = NULL;
     24          static int item_count = 0;
     25          static int item_cursor = 0;
     26          
     27          #ifdef ELKA
     28          static int hdr_icon=0x599;
     29          #else
     30          static int hdr_icon=0x5C5;
     31          #endif
     32          

   \                                 In segment DATA_C, align 4, align-sorted
     33          static const int menusoftkeys[]={0,1,2};
   \                     menusoftkeys:
   \   00000000   000000000100       DC32 0, 1, 2
   \              000002000000
     34          

   \                                 In segment DATA_I, align 4, align-sorted
     35          static SOFTKEY_DESC sk[]=
   \                     sk:
   \   00000000                      DS8 24
   \   00000018                      REQUIRE `?<Initializer for sk>`
     36          {
     37            {0x0018,0x0000,(int)"Обновить"},
     38            {0x0001,0x0000, (int)"Назад"},
     39            {0x003D,0x0000,(int)LGP_DOIT_PIC}
     40          };
     41          

   \                                 In segment DATA_I, align 4, align-sorted
     42          static SOFTKEYSTAB skt=
   \                     skt:
   \   00000000                      DS8 8
   \   00000008                      REQUIRE `?<Initializer for skt>`
     43          {
     44            sk,0
     45          };
     46          

   \                                 In segment CODE, align 4, keep-with-next
     47          static int items_menu_onkey(void *gui, GUI_MSG *msg)
     48          {
   \                     items_menu_onkey:
   \   00000000   00402DE9           PUSH     {LR}
     49            char utf8_str[128];
     50            char str[64];
     51            int res;
     52            VkDialog *dialog;
     53            struct list_head * pos;
     54            int i;
     55            
     56            if ((msg->gbsmsg->msg==KEY_DOWN)||(msg->gbsmsg->msg==LONG_PRESS))
   \   00000004   041091E5           LDR      R1,[R1, #+4]
   \   00000008   9330A0E3           MOV      R3,#+147
   \   0000000C   042091E5           LDR      R2,[R1, #+4]
   \   00000010   403F83E3           ORR      R3,R3,#0x100
   \   00000014   030052E1           CMP      R2,R3
   \   00000018   02308312           ADDNE    R3,R3,#+2
   \   0000001C   03005211           CMPNE    R2,R3
   \   00000020   0D00001A           BNE      ??items_menu_onkey_0
     57            { 
     58              switch(msg->gbsmsg->submess)
   \   00000024   081091E5           LDR      R1,[R1, #+8]
   \   00000028   011051E2           SUBS     R1,R1,#+1
   \   0000002C   0E00000A           BEQ      ??items_menu_onkey_1
   \   00000030   031051E2           SUBS     R1,R1,#+3
   \   00000034   1B00000A           BEQ      ??items_menu_onkey_2
   \   00000038   071051E2           SUBS     R1,R1,#+7
   \   0000003C   0800000A           BEQ      ??items_menu_onkey_3
   \   00000040   0F1051E2           SUBS     R1,R1,#+15
   \   00000044   0400001A           BNE      ??items_menu_onkey_0
     59              {     
     60              case ENTER_BUTTON:
     61                i = GetCurMenuItem(gui);
   \   00000048   8F0100EF           SWI      +399
     62                pos = get_ListByIndex(&dialogs, i);
   \   0000004C   0010A0E1           MOV      R1,R0
   \   00000050   ........           LDR      R0,??DataTable18  ;; dialogs
   \   00000054   ........           _BLF     get_ListByIndex,??get_ListByIndex??rA
     63                dialog = list_entry(pos, VkDialog, list);
     64                CreateChat(dialog);
   \   00000058   ........           _BLF     CreateChat,??CreateChat??rA
     65                break;
     66              
     67              case GREEN_BUTTON:
     68          #ifdef DEVELOP
     69                CreateDebugGUI();
     70          #endif
     71                break;
     72                
     73              case LEFT_SOFT:
     74                if (process == 0)
     75                {
     76                  process=LOAD_DIALOGS;
     77                  //int count = get_ListCount(&dialogs);
     78                  SUBPROC((void*)HttpSendReq, messages_getConversations(item_count, 10, 1, "photo_50,online"));//запрос списка диалогов
     79                  //AnimWidget_Wait_headline();
     80                }
     81                break;      
     82                
     83              case RIGHT_SOFT://close
     84                csm->dialogs_menu_gui_id = NULL;
     85                return(1);
     86              }
     87            }
     88            return (0);  
   \                     ??items_menu_onkey_0:
   \   0000005C   0000A0E3           MOV      R0,#+0
   \   00000060   0080BDE8           POP      {PC}             ;; return
   \                     ??items_menu_onkey_3:
   \   00000064   ........           _BLF     CreateDebugGUI,??CreateDebugGUI??rA
   \   00000068   FBFFFFEA           B        ??items_menu_onkey_0
   \                     ??items_menu_onkey_1:
   \   0000006C   ........           LDR      R0,??DataTable9  ;; process
   \   00000070   001090E5           LDR      R1,[R0, #+0]
   \   00000074   000051E3           CMP      R1,#+0
   \   00000078   F7FFFF1A           BNE      ??items_menu_onkey_0
   \   0000007C   ........           LDR      R3,??DataTable8  ;; `?<Constant "photo_50,online">`
   \   00000080   0A10A0E3           MOV      R1,#+10
   \   00000084   001080E5           STR      R1,[R0, #+0]
   \   00000088   30009FE5           LDR      R0,??items_menu_onkey_4  ;; hdr + 24
   \   0000008C   0120A0E3           MOV      R2,#+1
   \   00000090   000090E5           LDR      R0,[R0, #+0]
   \   00000094   ........           _BLF     messages_getConversations,??messages_getConversations??rA
   \   00000098   0010A0E1           MOV      R1,R0
   \   0000009C   ........           LDR      R0,??DataTable7  ;; HttpSendReq
   \   000000A0   710100EF           SWI      +369
   \   000000A4   ECFFFFEA           B        ??items_menu_onkey_0
   \                     ??items_menu_onkey_2:
   \   000000A8   ........           LDR      R0,??DataTable20  ;; csm
   \   000000AC   0010A0E3           MOV      R1,#+0
   \   000000B0   000090E5           LDR      R0,[R0, #+0]
   \   000000B4   381080E5           STR      R1,[R0, #+56]
   \   000000B8   0100A0E3           MOV      R0,#+1
   \   000000BC   0080BDE8           POP      {PC}
   \                     ??items_menu_onkey_4:
   \   000000C0   ........           DC32     hdr + 24
     89          }
     90          

   \                                 In segment CODE, align 4, keep-with-next
     91          static void UpdateHeader()
     92          {
   \                     UpdateHeader:
   \   00000000   30402DE9           PUSH     {R4,R5,LR}
     93            ws_hdr->wsbody[0] = 0; 
   \   00000004   ........           LDR      R4,??DataTable16  ;; hdr
     94            wsAppendChar(ws_hdr, UTF16_ENA_CENTER);
     95            wsprintf(ws_hdr, percent_t, "Сообщения");
   \   00000008   ........           LDR      R5,??DataTable13  ;; percent_t
   \   0000000C   140094E5           LDR      R0,[R4, #+20]
   \   00000010   0020A0E3           MOV      R2,#+0
   \   00000014   001090E5           LDR      R1,[R0, #+0]
   \   00000018   B020C1E1           STRH     R2,[R1, #+0]
   \   0000001C   1E10A0E3           MOV      R1,#+30
   \   00000020   E01C81E3           ORR      R1,R1,#0xE000
   \   00000024   1C0000EF           SWI      +28
   \   00000028   140094E5           LDR      R0,[R4, #+20]
   \   0000002C   082085E2           ADD      R2,R5,#+8
   \   00000030   0510A0E1           MOV      R1,R5
   \   00000034   240100EF           SWI      +292
     96            wsAppendChar(ws_hdr, UTF16_ALIGN_RIGHT);
   \   00000038   140094E5           LDR      R0,[R4, #+20]
   \   0000003C   1D10A0E3           MOV      R1,#+29
   \   00000040   E01C81E3           ORR      R1,R1,#0xE000
   \   00000044   1C0000EF           SWI      +28
     97            wstrcatprintf(ws_hdr, "%d/%d", item_cursor, get_DialogsCount());
   \   00000048   ........           _BLF     get_DialogsCount,??get_DialogsCount??rA
   \   0000004C   1C2094E5           LDR      R2,[R4, #+28]
   \   00000050   0030A0E1           MOV      R3,R0
   \   00000054   140094E5           LDR      R0,[R4, #+20]
   \   00000058   141085E2           ADD      R1,R5,#+20
   \   0000005C   160200EF           SWI      +534
     98          }
   \   00000060   3080BDE8           POP      {R4,R5,PC}       ;; return
     99          

   \                                 In segment CODE, align 4, keep-with-next
    100          static void items_menu_ghook(void *data, int cmd)
    101          {
   \                     items_menu_ghook:
   \   00000000   F14F2DE9           PUSH     {R0,R4-R11,LR}
    102            GUI *gui = (GUI*)data;
    103            
    104            if (cmd == TI_CMD_CREATE)
   \   00000004   ........           LDR      R4,??DataTable7  ;; HttpSendReq
   \   00000008   ........           LDR      R7,??DataTable8  ;; `?<Constant "photo_50,online">`
   \   0000000C   ........           LDR      R5,??DataTable9  ;; process
   \   00000010   ........           LDR      R6,??DataTable19  ;; hdr
   \   00000014   0180A0E3           MOV      R8,#+1
   \   00000018   0A90A0E3           MOV      R9,#+10
   \   0000001C   020051E3           CMP      R1,#+2
   \   00000020   2300001A           BNE      ??items_menu_ghook_0
    105            { 
    106              hdr.icon = &hdr_icon;
   \   00000024   201086E2           ADD      R1,R6,#+32
   \   00000028   081086E5           STR      R1,[R6, #+8]
    107              void* hdr_pointer=  GetHeaderPointer(gui);
   \   0000002C   AE0200EF           SWI      +686
   \   00000030   00A0A0E1           MOV      R10,R0
    108              ws_hdr = AllocWS(64);
   \   00000034   4000A0E3           MOV      R0,#+64
   \   00000038   250100EF           SWI      +293
   \   0000003C   140086E5           STR      R0,[R6, #+20]
    109              UpdateHeader();
   \   00000040   ........           BL       UpdateHeader
    110              SetHeaderText(hdr_pointer, ws_hdr, malloc_adr(), mfree_adr());
   \   00000044   158000EF           SWI      +32789
   \   00000048   00B0A0E1           MOV      R11,R0
   \   0000004C   148000EF           SWI      +32788
   \   00000050   141096E5           LDR      R1,[R6, #+20]
   \   00000054   0020A0E1           MOV      R2,R0
   \   00000058   0B30A0E1           MOV      R3,R11
   \   0000005C   0A00A0E1           MOV      R0,R10
   \   00000060   AF0200EF           SWI      +687
    111                  
    112              if (process == 0)
   \   00000064   000095E5           LDR      R0,[R5, #+0]
   \   00000068   000050E3           CMP      R0,#+0
   \   0000006C   F18FBD18           POPNE    {R0,R4-R11,PC}
    113              {
    114                process = LOAD_DIALOGS;
    115                sock_keepalive = 1;
   \   00000070   28019FE5           LDR      R0,??items_menu_ghook_1  ;; sock_keepalive
   \   00000074   009085E5           STR      R9,[R5, #+0]
   \   00000078   008080E5           STR      R8,[R0, #+0]
    116                SUBPROC((void*)HttpSendReq, messages_getConversations(0, 10, 1, "photo_50,online"));//запрос списка диалогов
   \   0000007C   0730A0E1           MOV      R3,R7
   \   00000080   0120A0E3           MOV      R2,#+1
   \   00000084   0910A0E1           MOV      R1,R9
   \   00000088   0000A0E3           MOV      R0,#+0
   \   0000008C   ........           _BLF     messages_getConversations,??messages_getConversations??rA
   \   00000090   0010A0E1           MOV      R1,R0
   \   00000094   0400A0E1           MOV      R0,R4
   \   00000098   710100EF           SWI      +369
    117                if (list_empty(&dialogs))
   \   0000009C   ........           LDR      R0,??DataTable18  ;; dialogs
   \   000000A0   001090E5           LDR      R1,[R0, #+0]
   \   000000A4   000051E1           CMP      R1,R0
   \   000000A8   F18FBD18           POPNE    {R0,R4-R11,PC}
    118                  AnimWidget_Wait_center();
   \   000000AC   ........           _BLF     AnimWidget_Wait_center,??AnimWidget_Wait_center??rA
   \   000000B0   F18FBDE8           POP      {R0,R4-R11,PC}
    119               // else
    120                  //AnimWidget_Wait_headline();
    121              }
    122            }
    123               
    124            if (cmd == TI_CMD_UNFOCUS)
   \                     ??items_menu_ghook_0:
   \   000000B4   090051E3           CMP      R1,#+9
   \   000000B8   0300001A           BNE      ??items_menu_ghook_2
    125            {
    126              AnimWidget_Close();
   \   000000BC   ........           _BLF     AnimWidget_Close,??AnimWidget_Close??rA
    127              DisableDynImages();
   \   000000C0   ........           _BLF     DisableDynImages,??DisableDynImages??rA
    128              DisableDynTheme();
   \   000000C4   ........           _BLF     DisableDynTheme,??DisableDynTheme??rA
   \   000000C8   F18FBDE8           POP      {R0,R4-R11,PC}
    129            }
    130            
    131            if (cmd==TI_CMD_FOCUS)
   \                     ??items_menu_ghook_2:
   \   000000CC   0A0051E3           CMP      R1,#+10
   \   000000D0   0300001A           BNE      ??items_menu_ghook_3
    132            {
    133             // if (GetMenuItemCount(gui) == 0)
    134             //   AnimWidget_Wait_body();
    135              
    136              EnableDynImages();
   \   000000D4   ........           _BLF     EnableDynImages,??EnableDynImages??rA
    137              EnableDynTheme();  
   \   000000D8   ........           _BLF     EnableDynTheme,??EnableDynTheme??rA
    138              DisableIDLETMR();
   \   000000DC   7F0100EF           SWI      +383
   \   000000E0   F18FBDE8           POP      {R0,R4-R11,PC}
    139              //Menu_SetItemCountDyn(gui, CLIST_GetCount(csm->dialogs_clist));
    140            }  
    141            
    142            if (cmd == TI_CMD_REDRAW)
   \                     ??items_menu_ghook_3:
   \   000000E4   070051E3           CMP      R1,#+7
   \   000000E8   2200001A           BNE      ??items_menu_ghook_4
    143            {
    144              item_cursor = GetCurMenuItem(gui);
   \   000000EC   8F0100EF           SWI      +399
    145             if (item_count) item_cursor++;
   \   000000F0   181096E5           LDR      R1,[R6, #+24]
   \   000000F4   000051E3           CMP      R1,#+0
   \   000000F8   01008012           ADDNE    R0,R0,#+1
   \   000000FC   1C0086E5           STR      R0,[R6, #+28]
    146              UpdateHeader();
   \   00000100   ........           BL       UpdateHeader
    147              
    148              if (process == 0)
   \   00000104   000095E5           LDR      R0,[R5, #+0]
   \   00000108   000050E3           CMP      R0,#+0
   \   0000010C   0E00001A           BNE      ??items_menu_ghook_5
    149              {
    150                if (item_cursor == item_count)
   \   00000110   180096E5           LDR      R0,[R6, #+24]
   \   00000114   1C1096E5           LDR      R1,[R6, #+28]
   \   00000118   000051E1           CMP      R1,R0
   \   0000011C   F18FBD18           POPNE    {R0,R4-R11,PC}
    151                {
    152                  process = LOAD_DIALOGS;
    153                  sock_keepalive = 1;
   \   00000120   78109FE5           LDR      R1,??items_menu_ghook_1  ;; sock_keepalive
   \   00000124   009085E5           STR      R9,[R5, #+0]
   \   00000128   008081E5           STR      R8,[R1, #+0]
    154                  SUBPROC((void*)HttpSendReq, messages_getConversations(item_count, 10, 1, "photo_50,online"));//запрос списка диалогов
   \   0000012C   0730A0E1           MOV      R3,R7
   \   00000130   0120A0E3           MOV      R2,#+1
   \   00000134   0910A0E1           MOV      R1,R9
   \   00000138   ........           _BLF     messages_getConversations,??messages_getConversations??rA
   \   0000013C   0010A0E1           MOV      R1,R0
   \   00000140   0400A0E1           MOV      R0,R4
   \   00000144   710100EF           SWI      +369
    155                  AnimWidget_Wait_bottom();
   \   00000148   ........           _BLF     AnimWidget_Wait_bottom,??AnimWidget_Wait_bottom??rA
    156                }
    157              }
    158              
    159              if (process && AnimWidget_IsBottom() && item_cursor != item_count)
   \                     ??items_menu_ghook_5:
   \   0000014C   000095E5           LDR      R0,[R5, #+0]
   \   00000150   000050E3           CMP      R0,#+0
   \   00000154   F18FBD08           POPEQ    {R0,R4-R11,PC}
   \   00000158   ........           _BLF     AnimWidget_IsBottom,??AnimWidget_IsBottom??rA
   \   0000015C   000050E3           CMP      R0,#+0
   \   00000160   1C009615           LDRNE    R0,[R6, #+28]
   \   00000164   18109615           LDRNE    R1,[R6, #+24]
   \   00000168   01005011           CMPNE    R0,R1
   \   0000016C   F18FBD08           POPEQ    {R0,R4-R11,PC}
    160                AnimWidget_Close();
   \   00000170   ........           _BLF     AnimWidget_Close,??AnimWidget_Close??rA
   \   00000174   F18FBDE8           POP      {R0,R4-R11,PC}
    161              
    162            }
    163            
    164            if (cmd == TI_CMD_DESTROY)
   \                     ??items_menu_ghook_4:
   \   00000178   030051E3           CMP      R1,#+3
   \   0000017C   F18FBD18           POPNE    {R0,R4-R11,PC}
    165            {
    166              AnimWidget_Close();
   \   00000180   ........           _BLF     AnimWidget_Close,??AnimWidget_Close??rA
    167              DisableDynTheme();
   \   00000184   ........           _BLF     DisableDynTheme,??DisableDynTheme??rA
    168              DisableDynImages();
   \   00000188   ........           _BLF     DisableDynImages,??DisableDynImages??rA
    169              csm->dialogs_menu_gui_id = NULL;
   \   0000018C   ........           LDR      R0,??DataTable20  ;; csm
   \   00000190   0010A0E3           MOV      R1,#+0
   \   00000194   000090E5           LDR      R0,[R0, #+0]
   \   00000198   381080E5           STR      R1,[R0, #+56]
    170            }
    171          }
   \   0000019C   F18FBDE8           POP      {R0,R4-R11,PC}   ;; return
   \                     ??items_menu_ghook_1:
   \   000001A0   ........           DC32     sock_keepalive
    172          

   \                                 In segment CODE, align 4, keep-with-next
    173          static void items_menu_iconhndl(void *gui, int curitem, void *user_pointer)
    174          { 
   \                     items_menu_iconhndl:
   \   00000000   F24F2DE9           PUSH     {R1,R4-R11,LR}
    175            struct list_head *pos;
    176            VkDialog *dialog;
    177            VkMsg *msg;
    178            VkUser *user;
    179            
    180            pos = get_ListByIndex(&dialogs, curitem);
    181            dialog = list_entry(pos, VkDialog, list);
    182            msg = get_DialogMsg(dialog);
    183            user = dialog->user;
    184            
    185            WSHDR *ws1 = AllocMenuWS(gui, 64);
    186            WSHDR *ws2 = AllocMenuWS(gui, 64);
    187            void *item = AllocMLMenuItem(gui);
    188            
    189            wsAppendChar(ws1, UTF16_FONT_SMALL_BOLD);
    190            
    191            if (user && wstrlen(user->first_name))
   \   00000004   ........           LDR      R10,??DataTable13  ;; percent_t
   \   00000008   0040A0E1           MOV      R4,R0
   \   0000000C   ........           LDR      R0,??DataTable18  ;; dialogs
   \   00000010   ........           _BLF     get_ListByIndex,??get_ListByIndex??rA
   \   00000014   00B0A0E1           MOV      R11,R0
   \   00000018   ........           _BLF     get_DialogMsg,??get_DialogMsg??rA
   \   0000001C   1C609BE5           LDR      R6,[R11, #+28]
   \   00000020   0050A0E1           MOV      R5,R0
   \   00000024   4010A0E3           MOV      R1,#+64
   \   00000028   0400A0E1           MOV      R0,R4
   \   0000002C   980100EF           SWI      +408
   \   00000030   0070A0E1           MOV      R7,R0
   \   00000034   4010A0E3           MOV      R1,#+64
   \   00000038   0400A0E1           MOV      R0,R4
   \   0000003C   980100EF           SWI      +408
   \   00000040   0080A0E1           MOV      R8,R0
   \   00000044   0400A0E1           MOV      R0,R4
   \   00000048   190200EF           SWI      +537
   \   0000004C   0090A0E1           MOV      R9,R0
   \   00000050   1310A0E3           MOV      R1,#+19
   \   00000054   E01C81E3           ORR      R1,R1,#0xE000
   \   00000058   0700A0E1           MOV      R0,R7
   \   0000005C   1C0000EF           SWI      +28
   \   00000060   000056E3           CMP      R6,#+0
   \   00000064   0700000A           BEQ      ??items_menu_iconhndl_0
   \   00000068   0C0096E5           LDR      R0,[R6, #+12]
   \   0000006C   230100EF           SWI      +291
   \   00000070   000050E3           CMP      R0,#+0
   \   00000074   0300000A           BEQ      ??items_menu_iconhndl_0
    192              wstrcat(ws1, user->first_name);
   \   00000078   0C1096E5           LDR      R1,[R6, #+12]
   \   0000007C   0700A0E1           MOV      R0,R7
   \   00000080   210100EF           SWI      +289
   \   00000084   030000EA           B        ??items_menu_iconhndl_1
    193            else
    194              wstrcatprintf(ws1, percent_d, dialog->user_id);
   \                     ??items_menu_iconhndl_0:
   \   00000088   08209BE5           LDR      R2,[R11, #+8]
   \   0000008C   03108AE2           ADD      R1,R10,#+3
   \   00000090   0700A0E1           MOV      R0,R7
   \   00000094   160200EF           SWI      +534
    195              
    196              wsAppendChar(ws2, UTF16_FONT_SMALL);
   \                     ??items_menu_iconhndl_1:
   \   00000098   1210A0E3           MOV      R1,#+18
   \   0000009C   E01C81E3           ORR      R1,R1,#0xE000
   \   000000A0   0800A0E1           MOV      R0,R8
   \   000000A4   1C0000EF           SWI      +28
    197              
    198              if (dialog->unread_count > 0 && msg->out == 0)//входящие непроч. красным
   \   000000A8   0C009BE5           LDR      R0,[R11, #+12]
   \   000000AC   0610A0E3           MOV      R1,#+6
   \   000000B0   E01C81E3           ORR      R1,R1,#0xE000
   \   000000B4   010050E3           CMP      R0,#+1
   \   000000B8   090000BA           BLT      ??items_menu_iconhndl_2
   \   000000BC   1C0095E5           LDR      R0,[R5, #+28]
   \   000000C0   000050E3           CMP      R0,#+0
   \   000000C4   0600001A           BNE      ??items_menu_iconhndl_2
    199              {
    200                wsAppendChar(ws2, UTF16_INK_RGBA);
   \   000000C8   0800A0E1           MOV      R0,R8
   \   000000CC   1C0000EF           SWI      +28
    201                wsAppendChar(ws2, 0xff00);//RG
   \   000000D0   FF1CA0E3           MOV      R1,#+65280
   \   000000D4   0800A0E1           MOV      R0,R8
   \   000000D8   1C0000EF           SWI      +28
    202                wsAppendChar(ws2, 0x0064);//BA - красный
   \   000000DC   6410A0E3           MOV      R1,#+100
   \   000000E0   0D0000EA           B        ??items_menu_iconhndl_3
    203              }
    204              else
    205                if (msg->out && dialog->out_read != msg->id)//исходящие непр. серым
   \                     ??items_menu_iconhndl_2:
   \   000000E4   1C0095E5           LDR      R0,[R5, #+28]
   \   000000E8   000050E3           CMP      R0,#+0
   \   000000EC   10009B15           LDRNE    R0,[R11, #+16]
   \   000000F0   08209515           LDRNE    R2,[R5, #+8]
   \   000000F4   02005011           CMPNE    R0,R2
   \   000000F8   0900000A           BEQ      ??items_menu_iconhndl_4
    206                {
    207                  wsAppendChar(ws2, UTF16_INK_RGBA);
   \   000000FC   0800A0E1           MOV      R0,R8
   \   00000100   1C0000EF           SWI      +28
    208                  wsAppendChar(ws2, 0x8080);//RG
   \   00000104   8010A0E3           MOV      R1,#+128
   \   00000108   801C81E3           ORR      R1,R1,#0x8000
   \   0000010C   0800A0E1           MOV      R0,R8
   \   00000110   1C0000EF           SWI      +28
    209                  wsAppendChar(ws2, 0x8064);//BA - серый
   \   00000114   6410A0E3           MOV      R1,#+100
   \   00000118   801C81E3           ORR      R1,R1,#0x8000
   \                     ??items_menu_iconhndl_3:
   \   0000011C   0800A0E1           MOV      R0,R8
   \   00000120   1C0000EF           SWI      +28
    210                }
    211              
    212              if (!list_empty(&msg->attachments))
   \                     ??items_menu_iconhndl_4:
   \   00000124   200085E2           ADD      R0,R5,#+32
   \   00000128   001090E5           LDR      R1,[R0, #+0]
   \   0000012C   000051E1           CMP      R1,R0
   \   00000130   0300001A           BNE      ??items_menu_iconhndl_5
    213                wstrcatprintf(ws2, percent_t, "вложение");
    214              else
    215                wstrcat(ws2, msg->text);
   \   00000134   181095E5           LDR      R1,[R5, #+24]
   \   00000138   0800A0E1           MOV      R0,R8
   \   0000013C   210100EF           SWI      +289
   \   00000140   030000EA           B        ??items_menu_iconhndl_6
   \                     ??items_menu_iconhndl_5:
   \   00000144   1C208AE2           ADD      R2,R10,#+28
   \   00000148   0A10A0E1           MOV      R1,R10
   \   0000014C   0800A0E1           MOV      R0,R8
   \   00000150   160200EF           SWI      +534
    216          
    217          /*    
    218              if (msg)
    219              {
    220              switch (msg->attachments)
    221              {
    222              case 0://only message
    223                if (msg->text)
    224                  wstrcat(ws2, msg->text);
    225                break;
    226                
    227              case 1://photo
    228                wstrcatprintf(ws2, "%t", "фото");
    229                break;      
    230                
    231              case 2://video
    232                wstrcatprintf(ws2, "%t", "видео");
    233                break;
    234              
    235              case 5://link
    236                wstrcatprintf(ws2, "%t", "ссылка");
    237                break;
    238                
    239              case 8://wall
    240                wstrcatprintf(ws2, "%t", "запись");
    241                break;
    242                        
    243              }
    244              */
    245              
    246              //SetMenuItemIconArray(gui, item, &i1_pic); //первым рисуется картинка из SetMenuItemIconArray
    247              if (user && user->photo_50_img)
   \                     ??items_menu_iconhndl_6:
   \   00000154   000056E3           CMP      R6,#+0
   \   00000158   0600000A           BEQ      ??items_menu_iconhndl_7
   \   0000015C   202096E5           LDR      R2,[R6, #+32]
   \   00000160   000052E3           CMP      R2,#+0
   \   00000164   0800001A           BNE      ??items_menu_iconhndl_8
   \   00000168   140096E5           LDR      R0,[R6, #+20]
   \   0000016C   000050E3           CMP      R0,#+0
    248                SetMenuItemIconIMGHDR(gui, item, user->photo_50_img);
    249              else
    250              {
    251                IMGHDR* img;
    252                
    253                if (user && user->deactivated)
    254                  img = PNGLIST_GetImgByIndex(0);//deactivated.png
   \   00000170   0000A013           MOVNE    R0,#+0
   \   00000174   0000001A           BNE      ??items_menu_iconhndl_9
    255                else
    256                  img = PNGLIST_GetImgByIndex(1);//camera.png
   \                     ??items_menu_iconhndl_7:
   \   00000178   0100A0E3           MOV      R0,#+1
   \                     ??items_menu_iconhndl_9:
   \   0000017C   ........           _BLF     PNGLIST_GetImgByIndex,??PNGLIST_GetImgByIndex??rA
    257                
    258                if (img)
   \   00000180   000050E3           CMP      R0,#+0
   \   00000184   0300000A           BEQ      ??items_menu_iconhndl_10
    259                  SetMenuItemIconIMGHDR(gui, item, img);
   \   00000188   0020A0E1           MOV      R2,R0
   \                     ??items_menu_iconhndl_8:
   \   0000018C   0910A0E1           MOV      R1,R9
   \   00000190   0400A0E1           MOV      R0,R4
   \   00000194   A30300EF           SWI      +931
    260           /*    
    261                if (process == 0) 
    262                {
    263                  csm->list = &dialogs;
    264                  process = LOAD_USERS_PHOTO_FROM_INET;
    265                  ipc.name_to =ipc_my_name;
    266                  ipc.name_from = ipc_my_name;
    267                  ipc.data = 0;
    268                  GBS_SendMessage(MMI_CEPID, MSG_IPC, IPC_RUN_MAIN_PROCESS, &ipc);        
    269                } 
    270                */
    271              }
    272              
    273              SetMLMenuItemText(gui, item, ws1, ws2, curitem);
   \                     ??items_menu_iconhndl_10:
   \   00000198   00009DE5           LDR      R0,[SP, #+0]
   \   0000019C   0830A0E1           MOV      R3,R8
   \   000001A0   01002DE9           PUSH     {R0}
   \   000001A4   0720A0E1           MOV      R2,R7
   \   000001A8   0910A0E1           MOV      R1,R9
   \   000001AC   0400A0E1           MOV      R0,R4
   \   000001B0   180200EF           SWI      +536
    274           //}
    275           // else
    276              //SetMLMenuItemText(gui, item, 0, 0, curitem);
    277          }
   \   000001B4   F38FBDE8           POP      {R0,R1,R4-R11,PC}  ;; return
    278          

   \                                 In segment DATA_C, align 4, align-sorted
    279          static const ML_MENU_DESC items_menu_desc=
   \                     items_menu_desc:
   \   00000000   08000000....       DC32 8, items_menu_onkey, items_menu_ghook, 0H, menusoftkeys, skt
   \              ............
   \              00000000....
   \              ............
   \   00000018   92000140....       DC32 1073807506, items_menu_iconhndl, 0H, 0H, 0, 1
   \              ....00000000
   \              000000000000
   \              000001000000
    280          {
    281            8,
    282            items_menu_onkey,
    283            items_menu_ghook,
    284            NULL,
    285            menusoftkeys,
    286            &skt,
    287            0x40010092, //0x80000083
    288            items_menu_iconhndl,
    289            NULL,   //Items
    290            NULL,   //Procs
    291            0,   //n
    292            1 //Добавочных строк  
    293          };
    294          
    295          //******************************************************************************
    296          

   \                                 In segment CODE, align 4, keep-with-next
    297          void RefreshDialogsMenu()
    298          {  
   \                     RefreshDialogsMenu:
   \   00000000   ........           LDR      R0,??DataTable20  ;; csm
   \   00000004   30402DE9           PUSH     {R4,R5,LR}
   \   00000008   000090E5           LDR      R0,[R0, #+0]
   \   0000000C   380090E5           LDR      R0,[R0, #+56]
   \   00000010   000050E3           CMP      R0,#+0
   \   00000014   3080BD08           POPEQ    {R4,R5,PC}
    299            if (csm->dialogs_menu_gui_id)
    300            {
    301              GUI* gui = FindGUIbyId(csm->dialogs_menu_gui_id, NULL);
    302              item_count = get_ListCount(&dialogs);
   \   00000018   ........           LDR      R5,??DataTable16  ;; hdr
   \   0000001C   0010A0E3           MOV      R1,#+0
   \   00000020   090200EF           SWI      +521
   \   00000024   0040A0E1           MOV      R4,R0
   \   00000028   ........           LDR      R0,??DataTable18  ;; dialogs
   \   0000002C   ........           _BLF     get_ListCount,??get_ListCount??rA
   \   00000030   180085E5           STR      R0,[R5, #+24]
    303              Menu_SetItemCountDyn(gui, item_count);
   \   00000034   0010A0E1           MOV      R1,R0
   \   00000038   0400A0E1           MOV      R0,R4
   \   0000003C   E60100EF           SWI      +486
    304            }
    305          }
   \   00000040   3080BDE8           POP      {R4,R5,PC}       ;; return
    306          
    307          //******************************************************************************
    308          

   \                                 In segment CODE, align 4, keep-with-next
    309          void CreateDialogsMenu()
    310          {
    311            int item_count = get_ListCount(&dialogs);
   \                     CreateDialogsMenu:
   \   00000000   ........           LDR      R0,??DataTable18  ;; dialogs
   \   00000004   70402DE9           PUSH     {R4-R6,LR}
   \   00000008   ........           _BLF     get_ListCount,??get_ListCount??rA
   \   0000000C   0040A0E1           MOV      R4,R0
    312            void *ma = malloc_adr(); 
   \   00000010   148000EF           SWI      +32788
   \   00000014   0050A0E1           MOV      R5,R0
    313            void *mf = mfree_adr();
   \   00000018   158000EF           SWI      +32789
    314            void *gui = GetMultiLinesMenuGUI(ma, mf); 
   \   0000001C   0010A0E1           MOV      R1,R0
   \   00000020   0500A0E1           MOV      R0,R5
   \   00000024   A50200EF           SWI      +677
    315            SetMenuToGUI(gui,&items_menu_desc);
   \   00000028   50109FE5           LDR      R1,??CreateDialogsMenu_0  ;; items_menu_desc
   \   0000002C   0060A0E1           MOV      R6,R0
   \   00000030   A70200EF           SWI      +679
    316            SetMenuItemCount(gui, item_count);
   \   00000034   0410A0E1           MOV      R1,R4
    317            SetCursorToMenuItem(gui, 0);
    318            patch_header(&hdr);
   \   00000038   ........           LDR      R4,??DataTable19  ;; hdr
   \   0000003C   0600A0E1           MOV      R0,R6
   \   00000040   C30100EF           SWI      +451
   \   00000044   0010A0E3           MOV      R1,#+0
   \   00000048   0600A0E1           MOV      R0,R6
   \   0000004C   C40100EF           SWI      +452
   \   00000050   0400A0E1           MOV      R0,R4
   \   00000054   ........           _BLF     patch_header,??patch_header??rA
    319            SetHeaderToMenu(gui,&hdr,ma); 
   \   00000058   0520A0E1           MOV      R2,R5
   \   0000005C   0410A0E1           MOV      R1,R4
   \   00000060   0600A0E1           MOV      R0,R6
   \   00000064   A60200EF           SWI      +678
    320            csm->dialogs_menu_gui_id = CreateGUI(gui); 
   \   00000068   0600A0E1           MOV      R0,R6
   \   0000006C   370100EF           SWI      +311
   \   00000070   ........           LDR      R1,??DataTable20  ;; csm
   \   00000074   001091E5           LDR      R1,[R1, #+0]
   \   00000078   380081E5           STR      R0,[R1, #+56]
    321          }
   \   0000007C   7080BDE8           POP      {R4-R6,PC}       ;; return
   \                     ??CreateDialogsMenu_0:
   \   00000080   ........           DC32     items_menu_desc

   \                                 In segment CODE, align 4, keep-with-next
   \                     ??DataTable7:
   \   00000000   ........           DC32     HttpSendReq

   \                                 In segment CODE, align 4, keep-with-next
   \                     ??DataTable8:
   \   00000000   ........           DC32     `?<Constant "photo_50,online">`

   \                                 In segment CODE, align 4, keep-with-next
   \                     ??DataTable9:
   \   00000000   ........           DC32     process

   \                                 In segment CODE, align 4, keep-with-next
   \                     ??DataTable13:
   \   00000000   ........           DC32     percent_t

   \                                 In segment CODE, align 4, keep-with-next
   \                     ??DataTable16:
   \   00000000   ........           DC32     hdr

   \                                 In segment CODE, align 4, keep-with-next
   \                     ??DataTable18:
   \   00000000   ........           DC32     dialogs

   \                                 In segment CODE, align 4, keep-with-next
   \                     ??DataTable19:
   \   00000000   ........           DC32     hdr

   \                                 In segment CODE, align 4, keep-with-next
   \                     ??DataTable20:
   \   00000000   ........           DC32     csm

   \                                 In segment DATA_ID, align 4, align-sorted
   \                     `?<Initializer for hdr>`:
   \   00000000   000000000000       DC16 0, 0, 0, 0
   \              0000        
   \   00000008   000000000000       DC32 0H, 0, 2147483647
   \              0000FFFFFF7F
   \                     `?<Initializer for ws_hdr>`:
   \   00000014   00000000           DC32 0H
   \                     `?<Initializer for item_count>`:
   \   00000018   00000000           DC32 0
   \                     `?<Initializer for item_cursor>`:
   \   0000001C   00000000           DC32 0
   \                     `?<Initializer for hdr_icon>`:
   \   00000020   C5050000           DC32 1477

   \                                 In segment DATA_ID, align 4, align-sorted
   \                     `?<Initializer for sk>`:
   \   00000000   18000000           DC16 24, 0
   \   00000004   ........           DC32 `?<Constant "\\316\\341\\355\\356\\342\\350\\362\\374">`
   \   00000008   01000000           DC16 1, 0
   \   0000000C   ........           DC32 `?<Constant "\\315\\340\\347\\340\\344">`
   \   00000010   3D000000           DC16 61, 0
   \   00000014   FBC0FF7F           DC32 2147467515

   \                                 In segment DATA_ID, align 4, align-sorted
   \                     `?<Initializer for skt>`:
   \   00000000   ........0000       DC32 sk, 0
   \              0000        

   \                                 In segment DATA_C, align 4, align-sorted
   \                     `?<Constant "\\316\\341\\355\\356\\342\\350\\362\\374">`:
   \   00000000   CEE1EDEEE2E8       DC8 "\316\341\355\356\342\350\362\374"
   \              F2FC00      
   \   00000009   000000             DC8 0, 0, 0

   \                                 In segment DATA_C, align 4, align-sorted
   \                     `?<Constant "\\315\\340\\347\\340\\344">`:
   \   00000000   CDE0E7E0E400       DC8 "\315\340\347\340\344"
   \   00000006   0000               DC8 0, 0

   \                                 In segment DATA_C, align 4, align-sorted
   \                     `?<Constant "photo_50,online">`:
   \   00000000   70686F746F5F       DC8 "photo_50,online"
   \              35302C6F6E6C
   \              696E6500    
    322          
    323          

   Maximum stack usage in bytes:

     Function            CSTACK
     --------            ------
     CreateDialogsMenu      16
     RefreshDialogsMenu     12
     UpdateHeader           12
     items_menu_ghook       40
     items_menu_iconhndl    44
     items_menu_onkey        4
     patch_header            8


   Segment part sizes:

     Function/Label                 Bytes
     --------------                 -----
     patch_header                     48
     percent_t                        40
     hdr                              36
     menusoftkeys                     12
     sk                               24
     skt                               8
     items_menu_onkey                196
     UpdateHeader                    100
     items_menu_ghook                420
     items_menu_iconhndl             440
     items_menu_desc                  48
     RefreshDialogsMenu               68
     CreateDialogsMenu               132
     ??DataTable7                      4
     ??DataTable8                      4
     ??DataTable9                      4
     ??DataTable13                     4
     ??DataTable16                     4
     ??DataTable18                     4
     ??DataTable19                     4
     ??DataTable20                     4
     ?<Initializer for hdr>           36
     ?<Initializer for sk>            24
     ?<Initializer for skt>            8
     ?<Constant "\316\341\355\356\342\350\362\374">
                                      12
     ?<Constant "\315\340\347\340\344">
                                       8
     ?<Constant "photo_50,online">    16
      Others                         240

 
 1 664 bytes in segment CODE
   136 bytes in segment DATA_C
    68 bytes in segment DATA_I
    68 bytes in segment DATA_ID
    12 bytes in segment INITTAB
 
 1 388 bytes of CODE  memory (+ 288 bytes shared)
   204 bytes of CONST memory
    68 bytes of DATA  memory

Errors: none
Warnings: 3
